{% extends "base.html" %}

{% block title %}Camera Real-time - H·ªá th·ªëng nh·∫≠n di·ªán khu√¥n m·∫∑t{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-camera me-2"></i>
                    Camera Real-time
                </h4>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div id="cameraControls">
                        <button class="btn btn-success btn-lg me-2" id="startCamera">
                            <i class="fas fa-play me-2"></i>B·∫≠t camera
                        </button>
                        <button class="btn btn-danger btn-lg d-none" id="stopCamera">
                            <i class="fas fa-stop me-2"></i>T·∫Øt camera
                        </button>
                    </div>
                </div>
                
                <div class="text-center">
                    <video id="video" class="img-fluid rounded" style="max-width: 100%; max-height: 500px;" autoplay muted></video>
                    <canvas id="canvas" class="d-none"></canvas>
                </div>
                
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="recognitionToggle" checked>
                                <label class="form-check-label" for="recognitionToggle">
                                    <i class="fas fa-brain me-2"></i>B·∫≠t nh·∫≠n di·ªán khu√¥n m·∫∑t
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="detectionToggle" checked>
                                <label class="form-check-label" for="detectionToggle">
                                    <i class="fas fa-eye me-2"></i>B·∫≠t ph√°t hi·ªán khu√¥n m·∫∑t
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="recognitionInfo" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Th√¥ng tin camera
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Tr·∫°ng th√°i:</strong>
                    <span id="cameraStatus" class="badge bg-secondary ms-2">Ch∆∞a kh·ªüi ƒë·ªông</span>
                </div>
                
                <div class="mb-3">
                    <strong>Khu√¥n m·∫∑t ph√°t hi·ªán:</strong>
                    <span id="faceCount" class="badge bg-primary ms-2">0</span>
                </div>
                
                <div class="mb-3">
                    <strong>FPS:</strong>
                    <span id="fps" class="badge bg-info ms-2">0</span>
                </div>
                
                <div class="mb-3">
                    <strong>ƒê·ªô ph√¢n gi·∫£i:</strong>
                    <div id="resolution" class="text-muted">-</div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>H∆∞·ªõng d·∫´n:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Click "B·∫≠t camera" ƒë·ªÉ kh·ªüi ƒë·ªông</li>
                        <li>ƒêi·ªÅu ch·ªânh v·ªã tr√≠ ƒë·ªÉ camera nh√¨n r√µ khu√¥n m·∫∑t</li>
                        <li>ƒê·∫£m b·∫£o √°nh s√°ng ƒë·ªß s√°ng</li>
                        <li>Nh√¨n th·∫≥ng v√†o camera ƒë·ªÉ c√≥ k·∫øt qu·∫£ t·ªët nh·∫•t</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    C√†i ƒë·∫∑t
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="cameraSelect" class="form-label">Ch·ªçn camera:</label>
                    <select class="form-select" id="cameraSelect">
                        <option value="">ƒêang t·∫£i...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="qualitySelect" class="form-label">Ch·∫•t l∆∞·ª£ng:</label>
                    <select class="form-select" id="qualitySelect">
                        <option value="640x480">640x480 (Nhanh)</option>
                        <option value="1280x720" selected>1280x720 (C√¢n b·∫±ng)</option>
                        <option value="1920x1080">1920x1080 (Ch·∫•t l∆∞·ª£ng cao)</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="thresholdSlider" class="form-label">
                        Ng∆∞·ª°ng nh·∫≠n di·ªán: <span id="thresholdValue">0.6</span>
                    </label>
                    <input type="range" class="form-range" id="thresholdSlider"
                           min="0.3" max="0.8" step="0.05" value="0.6">
                    <div class="form-text">Gi√° tr·ªã th·∫•p = nh·∫≠n di·ªán ch√≠nh x√°c h∆°n, cao = √≠t l·ªói h∆°n</div>
                </div>

                <div class="mb-3">
                    <label for="frameRateSlider" class="form-label">
                        T·∫ßn su·∫•t x·ª≠ l√Ω: <span id="frameRateValue">5</span> FPS
                    </label>
                    <input type="range" class="form-range" id="frameRateSlider"
                           min="1" max="10" step="1" value="5">
                    <div class="form-text">S·ªë frame x·ª≠ l√Ω m·ªói gi√¢y (th·∫•p = m∆∞·ª£t h∆°n, cao = ch√≠nh x√°c h∆°n)</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let stream = null;
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let animationId = null;
let lastTime = 0;
let frameCount = 0;
let fps = 0;
let lastProcessTime = 0;
let isProcessing = false;

// Camera controls
const startCameraBtn = document.getElementById('startCamera');
const stopCameraBtn = document.getElementById('stopCamera');
const cameraStatus = document.getElementById('cameraStatus');
const faceCount = document.getElementById('faceCount');
const fpsDisplay = document.getElementById('fps');
const resolution = document.getElementById('resolution');
const cameraSelect = document.getElementById('cameraSelect');
const qualitySelect = document.getElementById('qualitySelect');
const thresholdSlider = document.getElementById('thresholdSlider');
const thresholdValue = document.getElementById('thresholdValue');
const frameRateSlider = document.getElementById('frameRateSlider');
const frameRateValue = document.getElementById('frameRateValue');

// Toggles
const recognitionToggle = document.getElementById('recognitionToggle');
const detectionToggle = document.getElementById('detectionToggle');

// Get available cameras
async function getCameras() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        cameraSelect.innerHTML = '';
        videoDevices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `Camera ${cameraSelect.options.length + 1}`;
            cameraSelect.appendChild(option);
        });
        
        if (videoDevices.length === 0) {
            cameraSelect.innerHTML = '<option value="">Kh√¥ng t√¨m th·∫•y camera</option>';
        }
    } catch (error) {
        console.error('L·ªói khi l·∫•y danh s√°ch camera:', error);
        cameraSelect.innerHTML = '<option value="">L·ªói khi t·∫£i camera</option>';
    }
}

// Start camera
async function startCamera() {
    try {
        const constraints = {
            video: {
                deviceId: cameraSelect.value ? { exact: cameraSelect.value } : undefined,
                width: { ideal: parseInt(qualitySelect.value.split('x')[0]) },
                height: { ideal: parseInt(qualitySelect.value.split('x')[1]) }
            }
        };
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // Update UI
        startCameraBtn.classList.add('d-none');
        stopCameraBtn.classList.remove('d-none');
        cameraStatus.textContent = 'ƒêang ho·∫°t ƒë·ªông';
        cameraStatus.className = 'badge bg-success ms-2';
        
        // Get video dimensions
        video.onloadedmetadata = () => {
            resolution.textContent = `${video.videoWidth}x${video.videoHeight}`;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        };
        
        // Start processing
        startProcessing();
        
    } catch (error) {
        console.error('L·ªói khi kh·ªüi ƒë·ªông camera:', error);
        alert('Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông camera: ' + error.message);
    }
}

// Stop camera
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
    
    // Update UI
    startCameraBtn.classList.remove('d-none');
    stopCameraBtn.classList.add('d-none');
    cameraStatus.textContent = 'ƒê√£ d·ª´ng';
    cameraStatus.className = 'badge bg-secondary ms-2';
    faceCount.textContent = '0';
    fpsDisplay.textContent = '0';
    resolution.textContent = '-';
}

// Start processing frames
function startProcessing() {
    function processFrame(currentTime) {
        if (!stream) return;

        // Calculate FPS
        frameCount++;
        if (currentTime - lastTime >= 1000) {
            fps = frameCount;
            frameCount = 0;
            lastTime = currentTime;
            fpsDisplay.textContent = fps;
        }

        // Always process frame for display, but limit backend processing
        processVideoFrame(currentTime);

        animationId = requestAnimationFrame(processFrame);
    }

    animationId = requestAnimationFrame(processFrame);
}

// Process video frame for face detection/recognition
async function processVideoFrame(currentTime) {
    if (video.videoWidth === 0) return;

    // Draw current frame to canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Rate limiting based on frame rate slider
    const targetFPS = parseInt(frameRateSlider.value);
    const frameInterval = 1000 / targetFPS; // milliseconds between frames

    if (currentTime - lastProcessTime >= frameInterval && !isProcessing) {
        lastProcessTime = currentTime;

        // Send frame to backend for processing if detection is enabled
        if (detectionToggle.checked) {
            isProcessing = true;
            await processFrameWithBackend();
            isProcessing = false;
        } else {
            // Clear any previous drawings
            clearFaceOverlays();
            faceCount.textContent = '0';
            updateRecognitionInfo(0, []);
        }
    }
}

// Send frame to backend for face detection/recognition
async function processFrameWithBackend() {
    try {
        // Convert canvas to blob
        canvas.toBlob(async (blob) => {
            if (!blob) return;

            const formData = new FormData();
            formData.append('frame', blob, 'camera_frame.jpg');

            const response = await fetch('/process_camera_frame', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.error) {
                console.error('Backend error:', result.error);
                return;
            }

            // Update UI with results
            faceCount.textContent = result.face_count;
            updateRecognitionInfo(result.face_count, result.faces, result.warning);

            // Draw face overlays on canvas
            drawFaceOverlays(result.faces);

        }, 'image/jpeg', 0.8);

    } catch (error) {
        console.error('Error processing frame:', error);
        faceCount.textContent = '0';
        updateRecognitionInfo(0, []);
        clearFaceOverlays();
    }
}

// Draw face detection overlays on canvas
function drawFaceOverlays(faces) {
    // Clear previous drawings
    clearFaceOverlays();

    faces.forEach((face, index) => {
        const location = face.location;
        const x = location.left;
        const y = location.top;
        const width = location.right - location.left;
        const height = location.bottom - location.top;

        // Draw bounding box
        ctx.strokeStyle = face.has_match ? '#28a745' : '#ffc107';
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, width, height);

        // Draw label background
        const label = face.has_match ?
            `${face.name} (${face.confidence_percentage}%)` :
            `Unknown ${index + 1}`;

        ctx.fillStyle = face.has_match ? '#28a745' : '#ffc107';
        ctx.fillRect(x, y - 30, ctx.measureText(label).width + 10, 25);

        // Draw label text
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px Arial';
        ctx.fillText(label, x + 5, y - 10);
    });
}

// Clear face detection overlays
function clearFaceOverlays() {
    // Redraw the original video frame to clear overlays
    if (video.videoWidth > 0) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }
}

// Update recognition info display
function updateRecognitionInfo(faceCount, faces, warning = null) {
    const recognitionInfo = document.getElementById('recognitionInfo');

    // Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu c√≥
    if (warning) {
        recognitionInfo.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${warning}
                <br><small><a href="/" class="text-decoration-none">üëÜ ƒêƒÉng k√Ω khu√¥n m·∫∑t t·∫°i ƒë√¢y</a></small>
            </div>
        `;
        return;
    }

    if (faceCount === 0) {
        recognitionInfo.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-user-slash me-2"></i>
                Kh√¥ng ph√°t hi·ªán khu√¥n m·∫∑t n√†o
            </div>
        `;
    } else {
        let infoHtml = `
            <div class="alert alert-info">
                <i class="fas fa-users me-2"></i>
                Ph√°t hi·ªán ${faceCount} khu√¥n m·∫∑t
            </div>
        `;

        if (faces.length > 0 && recognitionToggle.checked) {
            infoHtml += '<div class="mt-2">';

            faces.forEach((face, index) => {
                if (face.has_match) {
                    const confidenceClass = face.confidence_level === 'high' ? 'success' :
                                          face.confidence_level === 'medium' ? 'warning' : 'secondary';

                    infoHtml += `
                        <div class="alert alert-${confidenceClass} py-2 mb-1">
                            <strong>${face.name}</strong> -
                            ƒê·ªô tin c·∫≠y: ${face.confidence_percentage}% (${face.confidence_level})
                        </div>
                    `;
                } else {
                    const message = face.message || `Khu√¥n m·∫∑t ${index + 1}: Kh√¥ng x√°c ƒë·ªãnh`;
                    infoHtml += `
                        <div class="alert alert-secondary py-2 mb-1">
                            <strong>${message}</strong>
                        </div>
                    `;
                }
            });

            infoHtml += '</div>';
        }

        recognitionInfo.innerHTML = infoHtml;
    }
}

// Event listeners
startCameraBtn.addEventListener('click', startCamera);
stopCameraBtn.addEventListener('click', stopCamera);

cameraSelect.addEventListener('change', () => {
    if (stream) {
        stopCamera();
        setTimeout(startCamera, 100);
    }
});

qualitySelect.addEventListener('change', () => {
    if (stream) {
        stopCamera();
        setTimeout(startCamera, 100);
    }
});

thresholdSlider.addEventListener('input', (e) => {
    thresholdValue.textContent = e.target.value;
});

frameRateSlider.addEventListener('input', (e) => {
    frameRateValue.textContent = e.target.value;
});

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    getCameras();
    
    // Request camera permission early
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            stream.getTracks().forEach(track => track.stop());
        })
        .catch(error => {
            console.log('Camera permission not granted yet');
        });
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    stopCamera();
});
</script>
{% endblock %}
