{% extends "base.html" %}

{% block title %}Trang chủ - Hệ thống nhận diện khuôn mặt{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <h1 class="display-4 text-primary mb-3">
                    <i class="fas fa-face-smile me-3"></i>
                    Hệ thống nhận diện khuôn mặt
                </h1>
                <p class="lead text-muted mb-4">
                    Sử dụng công nghệ AI tiên tiến để nhận diện và xác thực khuôn mặt một cách chính xác và nhanh chóng
                </p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="{{ url_for('register_face') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-user-plus me-2"></i>Đăng ký khuôn mặt mới
                    </a>
                    <a href="{{ url_for('camera') }}" class="btn btn-success btn-lg">
                        <i class="fas fa-camera me-2"></i>Mở camera
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="stats-card">
            <i class="fas fa-users fa-3x mb-3"></i>
            <div class="stats-number">{{ known_faces|length }}</div>
            <p class="mb-0">Khuôn mặt đã đăng ký</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <i class="fas fa-shield-alt fa-3x mb-3"></i>
            <div class="stats-number">99.9%</div>
            <p class="mb-0">Độ chính xác</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <i class="fas fa-bolt fa-3x mb-3"></i>
            <div class="stats-number">&lt;1s</div>
            <p class="mb-0">Thời gian xử lý</p>
        </div>
    </div>
</div>

<!-- Face Recognition Section -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-search me-2"></i>
                    Nhận diện khuôn mặt
                </h4>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Kéo thả ảnh vào đây hoặc click để chọn</h5>
                    <p class="text-muted mb-3">Hỗ trợ: JPG, PNG, GIF</p>
                    <input type="file" id="imageInput" accept="image/*" class="d-none">
                    <button class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-folder-open me-2"></i>Chọn ảnh
                    </button>
                </div>
                
                <div id="previewContainer" class="d-none mt-3">
                    <img id="imagePreview" class="img-fluid rounded" style="max-height: 400px;">
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="recognizeFace()">
                            <i class="fas fa-search me-2"></i>Nhận diện
                        </button>
                        <button class="btn btn-secondary" onclick="resetUpload()">
                            <i class="fas fa-times me-2"></i>Hủy
                        </button>
                    </div>
                </div>
                
                <div id="resultContainer" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Khuôn mặt đã đăng ký
                </h5>
            </div>
            <div class="card-body">
                {% if known_faces %}
                    <div class="row">
                        {% for name in known_faces.keys() %}
                        <div class="col-6 mb-3">
                            <div class="face-card card text-center p-3">
                                <i class="fas fa-user-circle fa-3x text-primary mb-2"></i>
                                <h6 class="mb-2">{{ name }}</h6>
                                <a href="{{ url_for('delete_face', name=name) }}" 
                                   class="btn btn-danger btn-sm"
                                   onclick="return confirm('Bạn có chắc muốn xóa khuôn mặt của {{ name }}?')">
                                    <i class="fas fa-trash me-1"></i>Xóa
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-user-slash fa-3x mb-3"></i>
                        <p>Chưa có khuôn mặt nào được đăng ký</p>
                        <a href="{{ url_for('register_face') }}" class="btn btn-primary">
                            <i class="fas fa-user-plus me-2"></i>Đăng ký ngay
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Hướng dẫn sử dụng
                </h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li>Đăng ký khuôn mặt mới trong mục "Đăng ký"</li>
                    <li>Upload ảnh cần nhận diện vào ô bên trái</li>
                    <li>Click "Nhận diện" để xem kết quả</li>
                    <li>Sử dụng camera real-time để nhận diện liên tục</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFile = null;

// Drag and drop functionality
const uploadArea = document.getElementById('uploadArea');
const imageInput = document.getElementById('imageInput');
const previewContainer = document.getElementById('previewContainer');
const imagePreview = document.getElementById('imagePreview');
const resultContainer = document.getElementById('resultContainer');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

imageInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    if (!file.type.startsWith('image/')) {
        alert('Vui lòng chọn file ảnh!');
        return;
    }
    
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (e) => {
        imagePreview.src = e.target.result;
        previewContainer.classList.remove('d-none');
        resultContainer.innerHTML = '';
    };
    reader.readAsDataURL(file);
}

function resetUpload() {
    selectedFile = null;
    imageInput.value = '';
    previewContainer.classList.add('d-none');
    resultContainer.innerHTML = '';
}

async function recognizeFace() {
    if (!selectedFile) {
        alert('Vui lòng chọn ảnh trước!');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', selectedFile);
    
    try {
        resultContainer.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang xử lý...</span>
                </div>
                <p class="mt-2">Đang nhận diện khuôn mặt...</p>
            </div>
        `;
        
        const response = await fetch('/recognize', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result);
        } else {
            resultContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${result.error}
                </div>
            `;
        }
    } catch (error) {
        resultContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Lỗi khi xử lý: ${error.message}
            </div>
        `;
    }
}

function displayResults(result) {
    let html = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            Tìm thấy ${result.face_count} khuôn mặt trong ảnh
        </div>
    `;
    
    if (result.results.length > 0) {
        html += '<div class="row">';
        result.results.forEach((face, index) => {
            // Debug: In ra dữ liệu face để kiểm tra
            console.log(`Face ${index + 1}:`, face);
            
            const bestMatch = face.best_match;
            const matches = face.matches || [];
            
            // Hiển thị kết quả nhận diện
            let matchText = 'Không xác định';
            let isRecognized = false;
            
            if (bestMatch && bestMatch.length >= 2) {
                const name = bestMatch[0];
                const similarity = bestMatch[1];
                const confidence = ((1 - similarity) * 100).toFixed(1);
                matchText = `${name} (${confidence}%)`;
                isRecognized = true;
            } else if (matches.length > 0) {
                // Fallback: sử dụng matches nếu best_match không có
                const firstMatch = matches[0];
                if (firstMatch && firstMatch.length >= 2) {
                    const name = firstMatch[0];
                    const similarity = firstMatch[1];
                    const confidence = ((1 - similarity) * 100).toFixed(1);
                    matchText = `${name} (${confidence}%)`;
                    isRecognized = true;
                }
            }
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Khuôn mặt ${index + 1}</h6>
                            <p class="mb-2"><strong>Kết quả:</strong> ${matchText}</p>
                            ${isRecognized ? 
                                `<span class="badge bg-success">Đã nhận diện</span>` : 
                                `<span class="badge bg-warning">Chưa biết</span>`
                            }
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    resultContainer.innerHTML = html;
}
</script>
{% endblock %}
